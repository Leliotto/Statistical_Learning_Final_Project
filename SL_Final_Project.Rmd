---
title: "SL_Final_Project"
author: "Davide Fabio"
date: "2025-04-23"
output:
  pdf_document:
    fig_width: 4
    fig_height: 2.5
  html_document:
    df_print: paged
  word_document: default
  html_notebook: default
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
# Opzioni globali per knitr
knitr::opts_chunk$set(echo = FALSE, results = 'show')
# knitr::opts_chunk$set(fig.width=3.5, fig.height=2)
knitr::opts_chunk$set(fig.align = 'center')

```

```{r}
library(ggplot2)
library(dplyr)

diabetes <- read.csv("diabetes.csv", header = TRUE) # dobbiamo tenerli tutti altrimenti perdiamo 2/3 del dataset
diabetes$gender <- factor(diabetes$gender, levels = c("male", "female"), labels = c("male", "female"))
diabetes$location <- factor(diabetes$location, levels = c("Buckingham", "Louisa"), labels = c("Buckingham", "Louisa"))
diabetes$frame <- factor(diabetes$frame, levels = c("small", "medium", "large"), labels = c("small", "medium", "large"))
diabetes$id <- NULL

# base tidy
library(tidyverse)     # dplyr, ggplot2, readr, …
# preprocessing + modelling
install.packages("rlang")
library(tidymodels)    # recipes, parsnip, workflows, rsample, yardstick
# per KNN‐impute (step_knnimpute usa fastknn)
install.packages("kknn")
library(kknn)

diabetes <- read.csv("diabetes.csv", header = TRUE) %>% 
  # fattori espliciti
  mutate(
    gender   = factor(gender,   levels = c("male", "female")),
    location = factor(location, levels = c("Buckingham", "Louisa")),
    frame    = factor(frame,    levels = c("small", "medium", "large"))
  ) %>% 
  select(-id)                       # rimuovi id

knn_rec <- recipe(~ ., data = diabetes) %>%        # nessuna outcome ancora
  # dummy delle categoriche (necessario perché kNN lavora su numerico)
  step_dummy(all_nominal_predictors()) %>%         
  # KNN-imput per *tutti* i predittori con NA
  step_knnimpute(all_predictors(), neighbors = 5, weight_func = "distance") %>% 
  # riportiamo le variabili factor dummy→back se serve (non indispensabile qui)
  step_undo_dummy(all_outcomes(), tidy = TRUE)

# esegui la ricetta
prepped <- prep(knn_rec, training = diabetes, verbose = TRUE)
diabetes_imp <- bake(prepped, new_data = NULL)

diabetes_imp <- diabetes_imp %>% 
  mutate(diagnosis = as.factor(if_else(glyhb > 7, 1, 0)))

diabetes_imp %>% 
  count(diagnosis)

sapply(diabetes_imp, function(x) sum(is.na(x)))     # nessun NA residuo

write_csv(diabetes_imp, "diabetes_knn.csv")

library(VIM)
diabetes_imp <- kNN(diabetes, k = 5, weightDist = TRUE, imp_var = FALSE)
diabetes_imp$diagnosis <- factor(if_else(diabetes_imp$glyhb > 7, 1, 0))


```

```{r}
# standardizzare secondo il massimo di colonna.
# oppure Z-score
# analisi univariata
# analisi bivariata
# rimozione missings
num_vars <- diabetes %>% select(where(is.numeric)) %>% names()
factor_vars <- c("gender", "frame", "location")

for (f in factor_vars) {
  for (n in num_vars) {
    p <- ggplot(diabetes, aes_string(x = f, y = n)) +
      geom_boxplot(fill = "#69b3a2", alpha = 0.7) +
      theme_minimal() +
      labs(title = paste("Distribuzione di", n, "per", f),
           x = f, y = n)
    print(p)
  }
}
```

```{r}
# Installazione e caricamento del pacchetto
library(mice)

# Visualizzazione del pattern dei dati mancanti
md.pattern(diabetes)

# Esecuzione dell'imputazione
# imputed_data <- mice(data, m = 5, method = 'pmm', seed = 123)

method_vector <- c("pmm", "pmm", "pmm", "pmm", "pmm", "logreg", "pmm", "logreg", "pmm", "pmm", "polyreg", "pmm", "pmm", "pmm", "pmm", "pmm", "pmm", "pmm")
imputed_data_custom <- mice(diabetes, method = method_vector, m = 5, maxit = 10)

# Estrazione del dataset completo
completed_data <- complete(imputed_data_custom, 1)

# Analisi dei dati imputati
summary(completed_data)


```
